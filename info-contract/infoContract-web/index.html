<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Info Contract DApp</title>
  <script src="./node_modules/ethers/dist/ethers.umd.js"></script>
  <script src="./node_modules/jquery/dist/jquery.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .section h3 {
      margin-top: 0;
      color: #555;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .disconnect-btn {
      background-color: #dc3545;
    }

    .disconnect-btn:hover {
      background-color: #c82333;
    }

    input[type="text"],
    input[type="number"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 3px;
      margin: 5px;
      width: 200px;
    }

    .result {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 3px;
      margin-top: 10px;
      border-left: 4px solid #007bff;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }

    .wallet-info {
      background-color: #e7f3ff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .wallet-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .events-log {
      max-height: 200px;
      overflow-y: auto;
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .event-item {
      padding: 8px;
      margin: 5px 0;
      background-color: white;
      border-radius: 3px;
      border-left: 3px solid #28a745;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Info Contract DApp</h1>

    <!-- é’±åŒ…è¿æ¥éƒ¨åˆ† -->
    <div class="section">
      <h3>ğŸ”— é’±åŒ…è¿æ¥</h3>
      <div class="wallet-buttons">
        <button id="connectWallet">è¿æ¥ MetaMask</button>
        <button id="disconnectWallet" class="disconnect-btn" style="display: none;">æ–­å¼€è¿æ¥</button>
      </div>
      <div id="walletInfo" class="wallet-info" style="display: none;">
        <p><strong>è´¦æˆ·åœ°å€:</strong> <span id="accountAddress"></span></p>
        <p><strong>ç½‘ç»œ:</strong> <span id="networkInfo"></span></p>
        <p><strong>ä½™é¢:</strong> <span id="balance"></span> ETH</p>
        <p><strong>è¿æ¥çŠ¶æ€:</strong> <span id="connectionStatus" style="color: #28a745;">å·²è¿æ¥</span></p>
      </div>
    </div>

    <!-- sayHi æ–¹æ³• -->
    <div class="section">
      <h3>ğŸ‘‹ Say Hi</h3>
      <button id="sayHiBtn" disabled>è°ƒç”¨ sayHi()</button>
      <div id="sayHiResult" class="result" style="display: none;"></div>
    </div>

    <!-- setInfo å’Œ getInfo æ–¹æ³• -->
    <div class="section">
      <h3>ğŸ“ è®¾ç½®å’Œè·å–ä¿¡æ¯</h3>
      <div>
        <input type="text" id="nameInput" placeholder="è¾“å…¥å§“å" />
        <input type="number" id="ageInput" placeholder="è¾“å…¥å¹´é¾„" />
        <button id="setInfoBtn" disabled>è®¾ç½®ä¿¡æ¯</button>
      </div>
      <div style="margin-top: 15px;">
        <button id="getInfoBtn" disabled>è·å–ä¿¡æ¯</button>
      </div>
      <div id="infoResult" class="result" style="display: none;"></div>
    </div>

    <!-- äº‹ä»¶ç›‘å¬ -->
    <div class="section">
      <h3>ğŸ“¡ äº‹ä»¶ç›‘å¬</h3>
      <div>
        <button id="startListening" disabled>å¼€å§‹ç›‘å¬äº‹ä»¶</button>
        <button id="stopListening" disabled>åœæ­¢ç›‘å¬</button>
        <button id="clearEvents">æ¸…ç©ºäº‹ä»¶æ—¥å¿—</button>
      </div>
      <div id="eventsLog" class="events-log">
        <p>ç­‰å¾…äº‹ä»¶...</p>
      </div>
    </div>
  </div>

  <script>
    // åˆçº¦åœ°å€å’ŒABI
    const CONTRACT_ADDRESS = "0xAEEa7B27e02eDd64c229dfd97FaE79Ac5fd7588A";
    // åˆçº¦çš„ABIä¿¡æ¯ï¼Œè®°å½•åˆçº¦æ‰€æœ‰å…¬å¼€æ–¹æ³•ã€äº‹ä»¶å’ŒçŠ¶æ€å˜é‡
    const CONTRACT_ABI = [
      {
        "inputs": [],
        "name": "age",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getInfo",
        "outputs": [
          { "internalType": "string", "name": "", "type": "string" },
          { "internalType": "uint256", "name": "", "type": "uint256" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "name",
        "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "sayHi",
        "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
        "stateMutability": "pure",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "string", "name": "_name", "type": "string" },
          { "internalType": "uint256", "name": "_age", "type": "uint256" }
        ],
        "name": "setInfo",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": false, "internalType": "string", "name": "name", "type": "string" },
          { "indexed": false, "internalType": "uint256", "name": "age", "type": "uint256" }
        ],
        "name": "InfoSet",
        "type": "event"
      }
    ];

    let provider;
    let signer;
    let contract;
    let account;
    let eventListener;
    let isConnected = false;

    // åˆå§‹åŒ–
    $(document).ready(function () {
      checkMetaMaskInstalled();
      setupEventListeners();
      checkExistingConnection();
    });

    // æ£€æŸ¥ MetaMask æ˜¯å¦å®‰è£…
    function checkMetaMaskInstalled() {
      if (typeof window.ethereum === 'undefined') {
        showResult('sayHiResult', 'è¯·å®‰è£… MetaMask!', 'error');
        return false;
      }
      return true;
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      $('#connectWallet').click(connectWallet);
      $('#disconnectWallet').click(disconnectWallet);
      $('#sayHiBtn').click(callSayHi);
      $('#setInfoBtn').click(setInfo);
      $('#getInfoBtn').click(getInfo);
      $('#startListening').click(startEventListening);
      $('#stopListening').click(stopEventListening);
      $('#clearEvents').click(clearEventLog);
    }

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿æ¥
    async function checkExistingConnection() {
      if (!checkMetaMaskInstalled()) return;

      try {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
          // å¦‚æœå·²æœ‰è¿æ¥ï¼Œè‡ªåŠ¨è¿æ¥
          await connectWallet();
        }
      } catch (error) {
        console.log('æ£€æŸ¥ç°æœ‰è¿æ¥æ—¶å‡ºé”™:', error);
      }
    }

    // è¿æ¥é’±åŒ…
    async function connectWallet() {
      try {
        // æ£€æŸ¥ MetaMask æ˜¯å¦å®‰è£…
        if (!checkMetaMaskInstalled()) return;

        // è¯·æ±‚è¿æ¥è´¦æˆ·
        await window.ethereum.request({ method: 'eth_requestAccounts' });

        // åˆ›å»º provider å’Œ signer - ethers v6 è¯­æ³•
        // provider ç”¨äºè®¿é—®åŒºå—é“¾æ•°æ®
        provider = new ethers.BrowserProvider(window.ethereum);
        // signer æ˜¯è´¦æˆ·çš„ä¿¡æ¯ï¼Œç”¨äºå¯¹æ¶ˆæ¯å’Œäº¤æ˜“è¿›è¡Œç­¾å
        signer = await provider.getSigner();
        // è·å–è´¦æˆ·åœ°å€
        account = await signer.getAddress();

        // åˆ›å»ºåˆçº¦å®ä¾‹
        // ä½¿ç”¨ signer åˆ›å»ºåˆçº¦å®ä¾‹ï¼Œç¡®ä¿åˆçº¦æ–¹æ³•çš„è°ƒç”¨å’Œäº‹ä»¶ç›‘å¬éƒ½ä½¿ç”¨æ­£ç¡®çš„è´¦æˆ·
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // è·å–é“¾ä¿¡æ¯
        const network = await provider.getNetwork();
        // è·å–å½“å‰è´¦æˆ·ä½™é¢
        const balance = await provider.getBalance(account);

        // æ›´æ–°UI - ä½¿ç”¨ ethers v6 çš„ formatEther
        $('#accountAddress').text(account);
        $('#networkInfo').text(`${network.name} (Chain ID: ${network.chainId})`);
        $('#balance').text(ethers.formatEther(balance));
        $('#connectionStatus').text('å·²è¿æ¥').css('color', '#28a745');
        $('#walletInfo').show();

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateConnectionUI(true);

        // å¯ç”¨åŠŸèƒ½æŒ‰é’®
        enableButtons(true);

        showResult('sayHiResult', 'é’±åŒ…è¿æ¥æˆåŠŸ!', 'success');

        // ç›‘å¬è´¦æˆ·å˜åŒ–ï¼Œè´¦æˆ·å˜æ›´å’Œé“¾æ¥æ–­å¼€éƒ½ä¼šè§¦å‘
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        // ç›‘å¬é“¾å˜åŒ–ï¼Œåˆ·æ–°é¡µé¢
        window.ethereum.on('chainChanged', () => window.location.reload());

        isConnected = true;

      } catch (error) {
        console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
        showResult('sayHiResult', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        updateConnectionUI(false);
      }
    }

    // æ–­å¼€é’±åŒ…è¿æ¥ï¼Œä½†ä¸ä¼šæ”¹å˜metaMaskä¸­æœ¬èº«çš„çŠ¶æ€
    function disconnectWallet() {
      try {
        // åœæ­¢äº‹ä»¶ç›‘å¬
        if (eventListener) {
          stopEventListening();
        }

        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
        if (window.ethereum) {
          window.ethereum.removeAllListeners('accountsChanged');
          window.ethereum.removeAllListeners('chainChanged');
        }

        // æ¸…ç©ºå˜é‡
        provider = null;
        signer = null;
        contract = null;
        account = null;
        isConnected = false;

        // æ›´æ–°UI
        updateConnectionUI(false);
        enableButtons(false);

        // æ¸…ç©ºé’±åŒ…ä¿¡æ¯
        $('#accountAddress').text('');
        $('#networkInfo').text('');
        $('#balance').text('');
        $('#connectionStatus').text('æœªè¿æ¥').css('color', '#dc3545');
        $('#walletInfo').hide();

        // æ¸…ç©ºç»“æœæ˜¾ç¤º
        $('.result').hide();

        // æ¸…ç©ºè¾“å…¥æ¡†
        $('#nameInput, #ageInput').val('');

        showResult('sayHiResult', 'é’±åŒ…å·²æ–­å¼€è¿æ¥', 'success');

      } catch (error) {
        console.error('æ–­å¼€è¿æ¥æ—¶å‡ºé”™:', error);
        showResult('sayHiResult', `æ–­å¼€è¿æ¥å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ›´æ–°è¿æ¥UIçŠ¶æ€
    function updateConnectionUI(connected) {
      if (connected) {
        $('#connectWallet').hide();
        $('#disconnectWallet').show();
      } else {
        $('#connectWallet').show();
        $('#disconnectWallet').hide();
      }
    }

    // å¤„ç†è´¦æˆ·å˜åŒ–
    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        // ç”¨æˆ·åœ¨ MetaMask ä¸­æ–­å¼€äº†è¿æ¥
        disconnectWallet();
      } else if (accounts[0] !== account) {
        // è´¦æˆ·å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°è¿æ¥
        showResult('sayHiResult', 'æ£€æµ‹åˆ°è´¦æˆ·å˜åŒ–ï¼Œæ­£åœ¨é‡æ–°è¿æ¥...', '');
        connectWallet();
      }
    }

    // å¯ç”¨/ç¦ç”¨æŒ‰é’®
    function enableButtons(enable) {
      $('#sayHiBtn, #setInfoBtn, #getInfoBtn, #startListening').prop('disabled', !enable);
    }

    // è°ƒç”¨ sayHi æ–¹æ³•
    async function callSayHi() {
      try {
        if (!isConnected) {
          showResult('sayHiResult', 'è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
          return;
        }

        showResult('sayHiResult', 'æ­£åœ¨è°ƒç”¨ sayHi...', '');
        const result = await contract.sayHi();
        showResult('sayHiResult', `ç»“æœ: ${result}`, 'success');
      } catch (error) {
        console.error('è°ƒç”¨ sayHi å¤±è´¥:', error);
        showResult('sayHiResult', `è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // è®¾ç½®ä¿¡æ¯
    async function setInfo() {
      try {
        if (!isConnected) {
          showResult('infoResult', 'è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
          return;
        }

        const name = $('#nameInput').val().trim();
        const age = $('#ageInput').val();

        if (!name || !age) {
          showResult('infoResult', 'è¯·è¾“å…¥å§“åå’Œå¹´é¾„', 'error');
          return;
        }

        if (age < 0 || age > 150) {
          showResult('infoResult', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å¹´é¾„ (0-150)', 'error');
          return;
        }

        showResult('infoResult', 'æ­£åœ¨è®¾ç½®ä¿¡æ¯...', '');

        // ethers v6 ä¸­ï¼ŒBigInt å¤„ç†ä¿æŒä¸å˜
        const tx = await contract.setInfo(name, BigInt(age));
        showResult('infoResult', `äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤... äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, '');
        // ç­‰å¾…äº¤æ˜“ç¡®è®¤
        const receipt = await tx.wait();
        showResult('infoResult', `ä¿¡æ¯è®¾ç½®æˆåŠŸ! åŒºå—: ${receipt.blockNumber}`, 'success');

        // æ¸…ç©ºè¾“å…¥æ¡†
        $('#nameInput, #ageInput').val('');

      } catch (error) {
        console.error('è®¾ç½®ä¿¡æ¯å¤±è´¥:', error);
        showResult('infoResult', `è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // è·å–ä¿¡æ¯
    async function getInfo() {
      try {
        if (!isConnected) {
          showResult('infoResult', 'è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
          return;
        }

        showResult('infoResult', 'æ­£åœ¨è·å–ä¿¡æ¯...', '');
        const result = await contract.getInfo();
        // ethers v6 è¿”å›çš„æ˜¯æ•°ç»„ï¼Œå¯ä»¥ç›´æ¥è§£æ„
        const [name, age] = result;
        showResult('infoResult', `å½“å‰ä¿¡æ¯ - å§“å: ${name || 'æœªè®¾ç½®'}, å¹´é¾„: ${age.toString() || 'æœªè®¾ç½®'}`, 'success');
      } catch (error) {
        console.error('è·å–ä¿¡æ¯å¤±è´¥:', error);
        showResult('infoResult', `è·å–å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // å¼€å§‹ç›‘å¬äº‹ä»¶
    function startEventListening() {
      try {
        if (!isConnected) {
          addEventLog('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
          return;
        }

        if (eventListener) {
          // ç§»é™¤ event çš„ç›‘å¬
          contract.off("InfoSet", eventListener);
        }

        // ç›‘å¬ event çš„å¤„ç†å‡½æ•°
        eventListener = (name, age, event) => {
          const timestamp = new Date().toLocaleString();
          const eventHtml = `
            <div class="event-item">
              <strong>InfoSet äº‹ä»¶è§¦å‘</strong><br>
              å§“å: ${name}<br>
              å¹´é¾„: ${age.toString()}<br>
              åŒºå—: ${event.log.blockNumber}<br>
              äº¤æ˜“å“ˆå¸Œ: ${event.log.transactionHash}<br>
              æ—¶é—´: ${timestamp}
            </div>
          `;

          if ($('#eventsLog p').text() === 'ç­‰å¾…äº‹ä»¶...') {
            $('#eventsLog').html(eventHtml);
          } else {
            $('#eventsLog').prepend(eventHtml);
          }
        };

        // ä½¿ç”¨åˆçº¦å®ä¾‹ç›‘å¬ InfoSet event
        contract.on("InfoSet", eventListener);

        $('#startListening').prop('disabled', true);
        $('#stopListening').prop('disabled', false);

        addEventLog('å¼€å§‹ç›‘å¬ InfoSet äº‹ä»¶...', 'success');

      } catch (error) {
        console.error('å¯åŠ¨äº‹ä»¶ç›‘å¬å¤±è´¥:', error);
        addEventLog(`å¯åŠ¨ç›‘å¬å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // åœæ­¢ç›‘å¬äº‹ä»¶
    function stopEventListening() {
      if (eventListener && contract) {
        // ç§»é™¤ event çš„ç›‘å¬
        contract.off("InfoSet", eventListener);
        eventListener = null;
      }

      $('#startListening').prop('disabled', false);
      $('#stopListening').prop('disabled', true);

      addEventLog('å·²åœæ­¢ç›‘å¬äº‹ä»¶', 'error');
    }

    // æ¸…ç©ºäº‹ä»¶æ—¥å¿—
    function clearEventLog() {
      $('#eventsLog').html('<p>ç­‰å¾…äº‹ä»¶...</p>');
    }

    // æ·»åŠ äº‹ä»¶æ—¥å¿—
    function addEventLog(message, type = '') {
      const timestamp = new Date().toLocaleString();
      const logHtml = `
        <div class="event-item ${type}">
          ${message}<br>
          <small>æ—¶é—´: ${timestamp}</small>
        </div>
      `;

      if ($('#eventsLog p').text() === 'ç­‰å¾…äº‹ä»¶...') {
        $('#eventsLog').html(logHtml);
      } else {
        $('#eventsLog').prepend(logHtml);
      }
    }

    // æ˜¾ç¤ºç»“æœ
    function showResult(elementId, message, type = '') {
      const $element = $(`#${elementId}`);
      $element.removeClass('error success').addClass(type);
      $element.html(message).show();
    }
  </script>
</body>

</html>